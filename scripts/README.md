# bigtable-autoscaler

Yoe re several ways to set the parameters used by the auto scaler to manage the number of inodes in a Bigtable instances. The easiest is actually to temporarily turn off IAP for the bigtable-autoscaler in the Google Console and make the changes by making a Postman PUT request in the Production environment.

But in case you want to do it while IAP is still enabled, follow the steps in [Google's documentation](https://cloud.google.com/iap/docs/authentication-howto) with help of the scripts in this directory. Note that for the scripts to work as is, you'd need to be logged in as Jos van Schagen as well as the ** BT Autoscaler Test JOs (to be deleted) ** client ID still exists.

Many Bigtable clusters have uneven load over time. To avoid wasting capacity (and money), it's 
desirable to scale down the cluster during off-hours. The Bigtable autoscaler lets you do that 
with no manual intervention.

##  Description of scripts

### Prerequisite

You need to be logged in with your Google ID and have executed the steps described in the ** Setting up the client ID ** section of the above referenced documentation. The end resuklt of these stepos are an ** other client ID ** and ** other client secret ** whoich need to be used in the scripts referenced below.

### getInitialAuthorizationCode.sh

* This script needs to be run only once per user.
* Substitute the ** other client ID ** for the value of ** client_id ** in the script.
* Executing the script in a shell will generate an ** Authorization code needed in the next script.

### getRefreshToken.sh

* This script needs to be run only once per user.
* Substitute the ** other client ID ** from the prerequisite step for the value of ** client_id ** in the script.
* Substitute the ** other client secret ** from the prerequisite step for the value of ** client_secret ** in the script.
* Substitute the ** Authorization code ** from running the previous step for the value of ** code ** in the script.
* Executing the script in a shell will generate a ** Refresh token ** needed in the next script.

### createIdToken.sh

* This script needs to be run whenever the ** id token ** generated by this call has expired, typically after 3600s.
* Substitute the ** other client ID ** from the prerequisite step for the value of ** client_id ** in the script.
* Substitute the ** other client secret ** from the prerequisite step for the value of ** client_secret ** in the script.
* Substitute the ** refresh token ** from running the previous step for the value of ** refresh_token ** in the script.
* It is believed the ** audience ** is already set to the correct value for this application. If not, follow the steps to find the ** IAP_CLIENT_ID ** as described in the cited reference above.
* Executing the script in a shell will generate an ** id token ** needed in any of the subsequent scripts.

### getSettingsInProduction.sh

* A GET request to get the current valuyes for the Bigtable Autoscaler.
* Substitute the ** id token ** from running the previous step for the value of ** Authorization: Bearer token ** in the script.

### updateSettingsInProduction.sh

* A POST request to get the current valuyes for the Bigtable Autoscaler.
* Substitute the ** id token ** from running the previous step for the value of ** Authorization: Bearer token ** in the script.
* Substitute the proper values for ** minNodes **, ** maxNodes **, ** cpuTarget **, and ** overloadStep **.
* It is believed all other values are already set to the correct value for this application.
* Run script and check updates using the ** getSettingsInProduction.sh ** script above.

### checkEnabled.sh

* A GET request to check whether autoscaling is enabled for the cluster
* Substitute the ** id token ** from running the previous step for the value of ** Authorization: Bearer token ** in the script.


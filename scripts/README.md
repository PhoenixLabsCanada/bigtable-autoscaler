# bigtable-autoscaler configuration

There are several ways to set the parameters used by the Bigtable auto scaler to manage the number of nodes for a Bigtable instance. The easiest is actually to temporarily turn off IAP for the **bigtable-autoscaler** in the Google Console and make the changes by making the Postman PUT request in our shared workspace in the Production environment with the desired values for **minNodes**, **maxNodes**, **cpuTarget**, and **overloadStep** set in the environment.

But in case you want to do it while IAP is still enabled, follow the steps in [Google's documentation](https://cloud.google.com/iap/docs/authentication-howto) with help of the scripts in this directory. Note that for the scripts to work as is, you'd need to be logged in as Jos van Schagen as well as while the **BT Autoscaler Test JOs (to be deleted)** client ID still needs to exist. Hence, there likely will be work to do ...

##  Description of scripts

### Prerequisite

You need to be logged in with your **Google ID** and have executed the steps described in the **Setting up the client ID** section of the above referenced documentation. The end result of these stepos are an **other client ID** and **other client secret** which need to be used in the scripts referenced below.

### getInitialAuthorizationCode.sh

* This script needs to be run only once per user.
* Substitute the **other client ID** for the value of **client_id** in the script.
* Executing the script in a shell will generate an **Authorization code** needed in the next script.

### getRefreshToken.sh

* This script needs to be run only once per user.
* Substitute the **other client ID**, obtained in the prerequisite step, for the value of **client_id** in the script.
* Substitute the **other client secret**, obtained in the prerequisite step, for the value of **client_secret** in the script.
* Substitute the **Authorization code** from the previous script for the value of **code** in the current script.
* Executing the script in a shell will generate a **Refresh token** needed in the next script.

### createIdToken.sh

* This script needs to be run whenever the **id token** generated by this call has expired, typically after 3600s.
* Substitute the **other client ID**, obtained in the prerequisite step, for the value of **client_id** in the script.
* Substitute the **other client secret**, obtained in the prerequisite step, for the value of **client_secret** in the script.
* Substitute the **refresh token** from running the previous script for the value of **refresh_token** in the current script.
* It is believed the **audience** is already set to the correct value for this application. If not, follow the steps to find the **IAP_CLIENT_ID** as described in the cited reference above.
* Executing the script in a shell will generate an **id token** needed in any of the subsequent scripts.

### getSettingsInProduction.sh

* A GET request to get the current valuyes for the Bigtable Autoscaler.
* Substitute the **id token**, obtained by running **createIdToken.sh** above, for the value of **Authorization: Bearer token** in the script.

### updateSettingsInProduction.sh

* A POST request to get the current valuyes for the Bigtable Autoscaler.
* Substitute the **id token**, obtained by running **createIdToken.sh** above, for the value of **Authorization: Bearer token** in the script.
* Substitute the desired values for **minNodes**, **maxNodes**, **cpuTarget**, and **overloadStep**.
* It is believed all other values are already set to the correct value for this application.
* Run script and check updates using the **getSettingsInProduction.sh** script above.

### checkEnabled.sh

* A GET request to check whether autoscaling is enabled for the cluster
* Substitute the **id token**, obtained by running **createIdToken.sh** above, for the value of **Authorization: Bearer token** in the script.

